<!DOCTYPE html>
<html>
<head>
    <style>
        #list {
            list-style: none;
            padding: 0;
        }
        .file-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .file-item p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }
        .file-item progress {
            width: 100%;
            height: 20px;
            margin: 5px 0;
        }
        .file-item button {
            margin-right: 10px;
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .file-item button:hover {
            background: #0056b3;
        }
        .file-item button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <ul id="list"></ul>

    <script>
        const formatdict = {
            "txt": "text/plain",
            "json": "application/json",
            "html": "text/html",
            "htm": "text/html",
            "css": "text/css",
            "js": "application/javascript",
            "mjs": "application/javascript",
            "cjs": "application/javascript",
            "jsx": "text/jsx",
            "ts": "application/typescript",
            "tsx": "text/tsx",
            "jpg": "image/jpeg",
            "jpeg": "image/jpeg",
            "png": "image/png",
            "gif": "image/gif",
            "webp": "image/webp",
            "svg": "image/svg+xml",
            "ico": "image/x-icon",
            "bmp": "image/bmp",
            "tiff": "image/tiff",
            "tif": "image/tiff",
            "mp3": "audio/mpeg",
            "wav": "audio/wav",
            "ogg": "audio/ogg",
            "flac": "audio/flac",
            "aac": "audio/aac",
            "m4a": "audio/mp4",
            "mp4": "video/mp4",
            "webm": "video/webm",
            "ogv": "video/ogg",
            "avi": "video/x-msvideo",
            "mov": "video/quicktime",
            "wmv": "video/x-ms-wmv",
            "flv": "video/x-flv",
            "mkv": "video/x-matroska",
            "woff": "font/woff",
            "woff2": "font/woff2",
            "ttf": "font/ttf",
            "otf": "font/otf",
            "eot": "application/vnd.ms-fontobject",
            "pdf": "application/pdf",
            "doc": "application/msword",
            "docx": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            "xls": "application/vnd.ms-excel",
            "xlsx": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            "ppt": "application/vnd.ms-powerpoint",
            "pptx": "application/vnd.openxmlformats-officedocument.presentationml.presentation",
            "odt": "application/vnd.oasis.opendocument.text",
            "ods": "application/vnd.oasis.opendocument.spreadsheet",
            "odp": "application/vnd.oasis.opendocument.presentation",
            "rtf": "application/rtf",
            "csv": "text/csv",
            "xml": "application/xml",
            "zip": "application/zip",
            "rar": "application/x-rar-compressed",
            "7z": "application/x-7z-compressed",
            "tar": "application/x-tar",
            "gz": "application/gzip",
            "bz2": "application/x-bzip2",
            "php": "application/x-httpd-php",
            "asp": "application/x-asap",
            "aspx": "application/x-asap",
            "jsp": "application/x-jsp",
            "wasm": "application/wasm",
            "swf": "application/x-shockwave-flash",
            "exe": "application/x-msdownload",
            "dmg": "application/x-apple-diskimage",
            "iso": "application/x-iso9660-image",
            "bin": "application/octet-stream",
        };

        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                alert('Token not found in URL');
                return;
            }
            
            const files = localStorage.getItem(token);
            if (!files) {
                alert('No files found for this token');
                return;
            }
            
            const filelist = JSON.parse(files);
            const list = document.getElementById('list');
            
            if (!filelist || !Array.isArray(filelist) || filelist.length === 0) {
                list.innerHTML = '<li>No files available</li>';
                return;
            }
            
            // 为每个文件创建列表项
            filelist.forEach((file, index) => {
                const li = document.createElement('li');
                li.id = `fileitem${index}`;
                li.className = 'file-item';
                
                const p = document.createElement('p');
                p.innerText = file.name || 'Unnamed file';
                
                const progressBar = document.createElement('progress');
                progressBar.value = 0;
                progressBar.max = 100;
                progressBar.style.display = 'none';
                
                const downloadButton = document.createElement('button');
                downloadButton.innerText = 'DOWNLOAD';
                downloadButton.dataset.index = index;
                
                const viewButton = document.createElement('button');
                viewButton.innerText = 'VIEW';
                viewButton.disabled = true;
                viewButton.dataset.index = index;
                
                const saveButton = document.createElement('button');
                saveButton.innerText = 'SAVE AS';
                saveButton.disabled = true;
                saveButton.dataset.index = index;
                
                const blobLink = document.createElement('a');
                blobLink.style.display = 'none';
                blobLink.download = file.name || 'file';
                
                // 存储文件信息
                li.dataset.fileInfo = JSON.stringify(file);
                
                // 添加事件监听器
                downloadButton.addEventListener('click', function() {
                    const idx = this.dataset.index;
                    getfile(idx);
                });
                
                viewButton.addEventListener('click', function() {
                    const link = document.querySelector(`#fileitem${this.dataset.index} a`);
                    if (link && link.href !== '#') {
                        window.open(link.href, '_blank');
                    }
                });
                
                saveButton.addEventListener('click', function() {
                    const link = document.querySelector(`#fileitem${this.dataset.index} a`);
                    if (link && link.href !== '#') {
                        link.click();
                    }
                });
                
                li.appendChild(p);
                li.appendChild(progressBar);
                li.appendChild(downloadButton);
                li.appendChild(viewButton);
                li.appendChild(saveButton);
                li.appendChild(blobLink);
                
                list.appendChild(li);
            });
        });

        async function getfile(index) {
            const li = document.getElementById(`fileitem${index}`);
            if (!li) return;
            
            const fileInfo = JSON.parse(li.dataset.fileInfo);
            const progressBar = li.querySelector('progress');
            const downloadButton = li.querySelector('button[data-index]');
            const viewButton = li.querySelectorAll('button')[1];
            const saveButton = li.querySelectorAll('button')[2];
            const blobLink = li.querySelector('a');
            
            try {
                // 禁用下载按钮，显示进度条
                downloadButton.disabled = true;
                progressBar.style.display = 'block';
                
                // 下载文件
                const content = await downloadFile(fileInfo.url, index);
                if (!content) {
                    throw new Error('Download failed');
                }
                
                // 解密内容
                const decrypted = await fixedSaltDecrypt(content, fileInfo.password);
                
                // 确定文件类型
                const filename = fileInfo.filename || fileInfo.name;
                const extension = filename.split('.').pop().toLowerCase();
                const type = formatdict[extension] || 'application/octet-stream';
                
                // 创建 blob URL
                const blob = new Blob([decrypted], { type: type });
                const blobUrl = URL.createObjectURL(blob);
                
                // 更新链接
                blobLink.href = blobUrl;
                blobLink.download = filename;
                
                // 启用查看和保存按钮
                viewButton.disabled = false;
                saveButton.disabled = false;
                
                // 更新进度条
                progressBar.value = 100;
                
                console.log(`File ${filename} ready for viewing/downloading`);
                
            } catch (error) {
                console.error('Error processing file:', error);
                alert(`Error processing file: ${error.message}`);
                downloadButton.disabled = false;
                progressBar.style.display = 'none';
            }
        }

        function downloadFile(url, index) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const li = document.getElementById(`fileitem${index}`);
                const progressBar = li.querySelector('progress');
                
                xhr.addEventListener('progress', (event) => {
                    if (event.lengthComputable) {
                        const percentComplete = (event.loaded / event.total) * 100;
                        progressBar.value = percentComplete;
                    }
                });
                
                xhr.addEventListener('load', () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(xhr.responseText);
                    } else {
                        reject(new Error(`Download failed with status: ${xhr.status}`));
                    }
                });
                
                xhr.addEventListener('error', () => {
                    reject(new Error('Network error during download'));
                });
                
                xhr.addEventListener('timeout', () => {
                    reject(new Error('Download timeout'));
                });
                
                xhr.open('GET', url);
                xhr.responseType = 'text';
                xhr.timeout = 30000; // 30秒超时
                xhr.send();
            });
        }

        async function fixedSaltDecrypt(encryptedBase64, password, appName = 'default') {
            try {
                const encoder = new TextEncoder();
                
                // 使用固定盐值
                const FIXED_SALT = encoder.encode('CLOUDDRIVESALT');
                
                // 生成 IV
                const ivSeed = await crypto.subtle.digest('SHA-256',
                    encoder.encode(password + appName)
                );
                const iv = new Uint8Array(ivSeed.slice(0, 12));
                
                // 使用固定盐值派生密钥
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(password),
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );
                
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: FIXED_SALT,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['decrypt']
                );
                
                const encryptedData = base64ToArrayBuffer(encryptedBase64);
                
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    encryptedData
                );
                
                return new TextDecoder().decode(decrypted);
            } catch (error) {
                console.error('Decryption error:', error);
                throw new Error('Failed to decrypt file. Check the password.');
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
    </script>
</body>
</html>