<!DOCTYPE html>
<html>
<head>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const files = localStorage.getItem(token);
        const filelist = JSON.parse(files);
        const list = document.getElementById('list');
        const formatdict = {
            "txt": "text/plain",
            "json": "application/json",
            "html": "text/html",
            "htm": "text/html",
            "css": "text/css",
            "js": "application/javascript",
            "mjs": "application/javascript",
            "cjs": "application/javascript",
            "jsx": "text/jsx",
            "ts": "application/typescript",
            "tsx": "text/tsx",

            // Images
            "jpg": "image/jpeg",
            "jpeg": "image/jpeg",
            "png": "image/png",
            "gif": "image/gif",
            "webp": "image/webp",
            "svg": "image/svg+xml",
            "ico": "image/x-icon",
            "bmp": "image/bmp",
            "tiff": "image/tiff",
            "tif": "image/tiff",

            // Audio
            "mp3": "audio/mpeg",
            "wav": "audio/wav",
            "ogg": "audio/ogg",
            "oga": "audio/ogg",
            "flac": "audio/flac",
            "aac": "audio/aac",
            "m4a": "audio/mp4",

            // Video
            "mp4": "video/mp4",
            "webm": "video/webm",
            "ogv": "video/ogg",
            "avi": "video/x-msvideo",
            "mov": "video/quicktime",
            "wmv": "video/x-ms-wmv",
            "flv": "video/x-flv",
            "mkv": "video/x-matroska",

            // Fonts
            "woff": "font/woff",
            "woff2": "font/woff2",
            "ttf": "font/ttf",
            "otf": "font/otf",
            "eot": "application/vnd.ms-fontobject",

            // Documents
            "pdf": "application/pdf",
            "doc": "application/msword",
            "docx": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            "xls": "application/vnd.ms-excel",
            "xlsx": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            "ppt": "application/vnd.ms-powerpoint",
            "pptx": "application/vnd.openxmlformats-officedocument.presentationml.presentation",
            "odt": "application/vnd.oasis.opendocument.text",
            "ods": "application/vnd.oasis.opendocument.spreadsheet",
            "odp": "application/vnd.oasis.opendocument.presentation",
            "rtf": "application/rtf",
            "csv": "text/csv",
            "xml": "application/xml",

            // Archives
            "zip": "application/zip",
            "rar": "application/x-rar-compressed",
            "7z": "application/x-7z-compressed",
            "tar": "application/x-tar",
            "gz": "application/gzip",
            "bz2": "application/x-bzip2",

            // Web files
            "php": "application/x-httpd-php",
            "asp": "application/x-asap",
            "aspx": "application/x-asap",
            "jsp": "application/x-jsp",

            // Other
            "wasm": "application/wasm",
            "swf": "application/x-shockwave-flash",
            "exe": "application/x-msdownload",
            "dmg": "application/x-apple-diskimage",
            "iso": "application/x-iso9660-image",
            "bin": "application/octet-stream",
        };

        for (let i = 0; i < filelist.length; i++) {
            const li = document.createElement('li');
            li.id = `fileitem${i}`;
            const p = document.createElement('p');
            p.innerText = filelist[i]["name"];
            const progressBar = document.createElement('progress');
            progressBar.value = 0;
            progressBar.max = 100;
            const downloadButton = document.createElement('button');
            downloadButton.innerText = 'DOWNLOAD';
            downloadButton.onclick = getfile(filelist[i]["url"], filelist[i]["password"], li.id);
            const saveButton = document.createElement('button');
            const viewButton = document.createElement('button');
            viewButton.innerText = 'VIEW';
            viewButton.onclick = open(document.querySelector(`#${li.id} a`), "_blank");
            saveButton.innerText = 'SAVE AS';
            saveButton.onclick = savefile(bloburl, filelist[i]["name"]);
            blob = document.createElement('a');
            blob.href = "data:text/plain,You need to DOWNLOAD before viewing!";
            blob.style.display = 'none';
            li.appendChild(blob);
            li.appendChild(p);
            li.appendChild(progressBar);
            li.appendChild(downloadButton);
            li.appendChild(saveButton);
            li.appendChild(viewButton);
            list.appendChild(li);
        }


        async function getfile(url,password,id) {
            var content = await download(url,id);
            var decrypted = await fixedSaltDecrypt(content, password);
            type = formatdict[filelist[i]["filename"].split('.')[-1]];
            if (type == null || type == undefined) {
                type = 'application/octet-stream';
            }
            document.querySelector(`#${id} a`).href = URL.createObjectURL(new Blob([decrypted], {type: type}));
        }

        async function fixedSaltDecrypt(encryptedBase64, password, appName = 'default') {
            const encoder = new TextEncoder();

            // 使用固定盐值（比没有稍好，但仍不安全）
            const FIXED_SALT = encoder.encode('CLOUDDRIVESALT');
            const FIXED_IV_SEED = encoder.encode('CLOUDDRIVESEED');

            // 生成 IV（从固定种子+密码）
            const ivSeed = await crypto.subtle.digest('SHA-256',
                encoder.encode(password + appName)
            );
            const iv = new Uint8Array(ivSeed.slice(0, 12));

            // 使用固定盐值派生密钥
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveKey']
            );

            const key = await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: FIXED_SALT, // 固定盐值
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['decrypt']
            );

            const encryptedData = base64ToArrayBuffer(encryptedBase64);

            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                encryptedData
            );

            return new TextDecoder().decode(decrypted);
        }

        function download(url,id) {
            const xhr = new XMLHttpRequest();
            xhr.addEventListener('progress', (event) => {
                if (event.lengthComputable) {
                    const percentComplete = (event.loaded / event.total) * 100;
                    document.querySelector(`#${id} progress`).value = percentComplete;
                }
            });
            xhr.open('GET', url);
            xhr.addEventListener('load', () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    return xhr.response;
                } else {
                    return download(url,id);
                }
            });
            xhr.responseType = 'text';
            xhr.send();
        }
    </script>
</head>
<body>
    <ul id="list">
    </ul>
</body>
</html>